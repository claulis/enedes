<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema ENEDES</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
    <header class="bg-blue-600 text-white p-4">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold">Sistema ENEDES</h1>
            <nav>
                <a href="/dashboard" class="mr-4">📊 Dashboard</a>
                <a href="/export" class="mr-4">📥 Exportar</a>
                <a href="/logout" class="mr-4">🚪 Sair</a>
            </nav>
        </div>
    </header>

    <main class="container mx-auto mt-8 p-4">
        <% if (error) { %>
            <div class="bg-red-100 text-red-700 p-4 rounded mb-4">
                <%= error %>
            </div>
        <% } %>

        <% if (action) { %>
            <h2 class="text-2xl font-bold mb-4">Editar Ação</h2>
            <div class="bg-white p-6 rounded shadow">
                <form action="/action/<%= action.id %>" method="POST" enctype="multipart/form-data">
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-2">📋 Informações Básicas</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="task" class="block text-gray-700 font-bold">Tarefa/Ação *</label>
                                <input type="text" name="task" id="task" value="<%= action.task %>" class="w-full p-2 border rounded" required>
                            </div>
                            <div>
                                <label for="responsible" class="block text-gray-700 font-bold">Responsável *</label>
                                <select name="responsible" id="responsible" class="w-full p-2 border rounded" required>
                                    <option value="">Selecione um responsável...</option>
                                    <% collaborators.forEach(collaborator => { %>
                                        <option value="<%= collaborator.name %>" <%= action.responsible === collaborator.name ? 'selected' : '' %>><%= collaborator.name %></option>
                                    <% }) %>
                                </select>
                            </div>
                            <div>
                                <label for="section" class="block text-gray-700 font-bold">Seção *</label>
                                <select name="section" id="section" class="w-full p-2 border rounded" required>
                                    <option value="">Selecione uma seção...</option>
                                    <% sections.forEach(section => { %>
                                        <option value="<%= section %>" <%= action.section_name === section ? 'selected' : '' %>><%= section %></option>
                                    <% }) %>
                                </select>
                            </div>
                            <div>
                                <label for="deadline" class="block text-gray-700 font-bold">Prazo *</label>
                                <input type="date" name="deadline" id="deadline" value="<%= action.deadline.toISOString().split('T')[0] %>" class="w-full p-2 border rounded" required>
                            </div>
                            <div>
                                <label for="budget" class="block text-gray-700 font-bold">Orçamento</label>
                                <input type="text" name="budget" id="budget" value="<%= action.budget %>" class="w-full p-2 border rounded">
                            </div>
                            <div>
                                <label for="status" class="block text-gray-700 font-bold">Status *</label>
                                <select name="status" id="status" class="w-full p-2 border rounded" required>
                                    <option value="pendente" <%= action.status === 'pendente' ? 'selected' : '' %>>Pendente</option>
                                    <option value="em_andamento" <%= action.status === 'em_andamento' ? 'selected' : '' %>>Em Andamento</option>
                                    <option value="alerta" <%= action.status === 'alerta' ? 'selected' : '' %>>Alerta</option>
                                    <option value="concluida" <%= action.status === 'concluida' ? 'selected' : '' %>>Concluída</option>
                                    <option value="atrasado" <%= action.status === 'atrasado' ? 'selected' : '' %>>Atrasado</option>
                                </select>
                            </div>
                            <div>
                                <label for="priority" class="block text-gray-700 font-bold">Prioridade *</label>
                                <select name="priority" id="priority" class="w-full p-2 border rounded" required>
                                    <option value="low" <%= action.priority === 'low' ? 'selected' : '' %>>Baixa</option>
                                    <option value="medium" <%= action.priority === 'medium' ? 'selected' : '' %>>Média</option>
                                    <option value="high" <%= action.priority === 'high' ? 'selected' : '' %>>Alta</option>
                                </select>
                            </div>
                            <div class="col-span-2">
                                <label for="description" class="block text-gray-700 font-bold">Descrição</label>
                                <textarea name="description" id="description" class="w-full p-2 border rounded" rows="4"><%= action.description %></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-2">✅ Tarefas</h3>
                        <% if (tasks && tasks.length > 0) { %>
                            <div class="space-y-2">
                                <% tasks.forEach((task, index) => { %>
                                    <div class="flex items-center space-x-2">
                                        <input type="text" name="tasks[<%= index %>][description]" value="<%= task.description %>" class="w-full p-2 border rounded">
                                        <input type="checkbox" name="tasks[<%= index %>][completed]" <%= task.completed ? 'checked' : '' %> class="ml-4">
                                        <label class="mr-2">Concluída</label>
                                        <a href="/task/edit/<%= task.id %>" class="text-blue-600 hover:underline">Editar</a>
                                        <a href="/task/delete/<%= task.id %>" class="text-red-600 hover:underline" onclick="return confirm('Tem certeza que deseja excluir esta tarefa?')">Excluir</a>
                                    </div>
                                <% }) %>
                            </div>
                        <% } else { %>
                            <p>Nenhuma tarefa encontrada.</p>
                        <% } %>
                        <a href="#" class="text-blue-600 hover:underline" onclick="addTask()">➕ Adicionar Tarefa</a>
                        <script>
                            function addTask() {
                                const container = document.createElement('div');
                                container.className = 'flex items-center space-x-2 mt-2';
                                container.innerHTML = `
                                    <input type="text" name="tasks[${document.querySelectorAll('[name^=tasks]').length / 2}][description]" class="w-full p-2 border rounded" placeholder="Descrição da tarefa">
                                    <input type="checkbox" name="tasks[${document.querySelectorAll('[name^=tasks]').length / 2}][completed]" class="ml-4">
                                    <label class="mr-2">Concluída</label>
                                `;
                                document.querySelector('.space-y-2').appendChild(container);
                            }
                        </script>
                    </div>

                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-2">📎 Anexos</h3>
                        <% if (attachments && attachments.length > 0) { %>
                            <ul class="list-disc pl-5">
                                <% attachments.forEach(attachment => { %>
                                    <li>
                                        <a href="/attachment/action/<%= attachment.id %>" class="text-blue-600 hover:underline"><%= attachment.original_name %></a>
                                        <a href="/attachment/delete/action/<%= attachment.id %>" class="text-red-600 hover:underline" onclick="return confirm('Tem certeza que deseja excluir este anexo?')">Excluir</a>
                                    </li>
                                <% }) %>
                            </ul>
                        <% } else { %>
                            <p>Nenhum anexo encontrado.</p>
                        <% } %>
                        <input type="file" name="attachments" multiple class="w-full p-2 border rounded mt-2">
                        <p class="text-sm text-gray-600">Formatos permitidos: PDF, DOCX, XLSX, JPG, PNG (máx. 10MB)</p>
                    </div>

                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-2">🔄 Follow-ups</h3>
                        <% if (followUps && followUps.length > 0) { %>
                            <ul class="list-disc pl-5">
                                <% followUps.forEach(followUp => { %>
                                    <li>
                                        <a href="/follow-up/<%= followUp.id %>" class="text-blue-600 hover:underline"><%= followUp.title %></a>
                                        <a href="/follow-up/edit/<%= followUp.id %>" class="text-blue-600 hover:underline">Editar</a>
                                        <a href="/follow-up/delete/<%= followUp.id %>" class="text-red-600 hover:underline" onclick="return confirm('Tem certeza que deseja excluir este follow-up?')">Excluir</a>
                                    </li>
                                <% }) %>
                            </ul>
                        <% } else { %>
                            <p>Nenhum follow-up encontrado.</p>
                        <% } %>
                        <a href="/follow-up/new/<%= action.id %>" class="text-blue-600 hover:underline">➕ Adicionar Follow-up</a>
                    </div>

                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-2">📋 Atribuições de Tarefas</h3>
                        <% if (assignments && assignments.length > 0) { %>
                            <ul class="list-disc pl-5">
                                <% assignments.forEach(assignment => { %>
                                    <li>
                                        <%= assignment.status %> - 
                                        <%= assignment.collaborator_name || 'Colaborador ID: ' + assignment.collaborator_id %> 
                                        (<%= assignment.task_description || 'Tarefa ID: ' + assignment.task_id %>)
                                        <a href="/task-assignment/edit/<%= assignment.id %>" class="text-blue-600 hover:underline">Editar</a>
                                        <a href="/task-assignment/delete/<%= assignment.id %>" class="text-red-600 hover:underline" onclick="return confirm('Tem certeza que deseja excluir esta atribuição?')">Excluir</a>
                                    </li>
                                <% }) %>
                            </ul>
                        <% } else { %>
                            <p>Nenhuma atribuição encontrada.</p>
                        <% } %>
                        <a href="/task-assignment/new/<%= action.id %>" class="text-blue-600 hover:underline">➕ Adicionar Atribuição</a>
                    </div>

                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-2">📝 Observações</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="col-span-2">
                                <label for="note" class="block text-gray-700 font-bold">Observações</label>
                                <textarea name="note" id="note" class="w-full p-2 border rounded" rows="4"><%= action.note %></textarea>
                            </div>
                            <div>
                                <input type="checkbox" name="completed" id="completed" <%= action.completed ? 'checked' : '' %> class="mr-2">
                                <label for="completed" class="text-gray-700">Ação concluída</label>
                            </div>
                            <div>
                                <input type="checkbox" name="validated" id="validated" <%= action.validated ? 'checked' : '' %> class="mr-2">
                                <label for="validated" class="text-gray-700">Validada pela coordenação</label>
                            </div>
                        </div>
                    </div>

                    <div class="flex space-x-4">
                        <a href="/dashboard" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">Cancelar</a>
                        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Salvar Ação</button>
                    </div>
                </form>
                <form action="/action/delete/<%= action.id %>" method="GET" class="mt-4">
                    <button type="submit" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700" onclick="return confirm('Tem certeza que deseja excluir esta ação?')">Excluir Ação</button>
                </form>
            </div>
        <% } else { %>
            <div class="bg-red-100 text-red-700 p-4 rounded mb-4">
                Ação não encontrada.
            </div>
            <a href="/dashboard" class="bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">Voltar ao Dashboard</a>
        <% } %>
    </main>
</body>
</html>